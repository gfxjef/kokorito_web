# üóÑÔ∏è **ESQUEMA DE BASE DE DATOS - KOKORITO**

Documentaci√≥n completa de la estructura de la base de datos **`atusalud_kokorito`** con **8 tablas** y sus relaciones.

---

## üéØ **RESUMEN EJECUTIVO**

La base de datos est√° dise√±ada con un **patr√≥n relacional normalizado** que permite:
- ‚úÖ **Flexibilidad** en productos (m√∫ltiples tama√±os y rellenos)
- ‚úÖ **Escalabilidad** para nuevos productos y categor√≠as  
- ‚úÖ **Integridad referencial** entre todas las entidades
- ‚úÖ **Optimizaci√≥n** para consultas frecuentes

---

## üìã **TABLAS PRINCIPALES**

### üè∑Ô∏è **1. CATEGORIA** (5 registros, 14 columnas)
**Prop√≥sito:** Organizaci√≥n jer√°rquica de productos

| Campo | Tipo | Descripci√≥n | Relaci√≥n |
|-------|------|-------------|----------|
| `id` | INT PK | Identificador √∫nico | ‚û°Ô∏è `producto.categoria_id` |
| `nombre` | VARCHAR | Nombre de la categor√≠a | |
| `slug` | VARCHAR | URL amigable | |
| `parent_id` | INT FK | Categor√≠a padre (jerarqu√≠a) | ‚Ü©Ô∏è `categoria.id` |
| `is_featured` | BOOLEAN | Categor√≠a destacada | |
| `is_active` | BOOLEAN | Estado activo/inactivo | |

**Caracter√≠sticas especiales:**
- üîÑ **Auto-relaci√≥n** (`parent_id`) para subcategor√≠as
- üé® **Personalizaci√≥n visual** (`color_tema`, `imagen_url`)
- üìà **SEO optimizado** (`meta_title`, `meta_description`)

---

### üõçÔ∏è **2. PRODUCTO** (6 registros, 27 columnas)
**Prop√≥sito:** Cat√°logo principal de productos

| Campo | Tipo | Descripci√≥n | Relaci√≥n |
|-------|------|-------------|----------|
| `id` | INT PK | Identificador √∫nico | ‚¨ÖÔ∏è M√∫ltiples tablas |
| `categoria_id` | INT FK | Categor√≠a del producto | ‚û°Ô∏è `categoria.id` |
| `nombre` | VARCHAR | Nombre del producto | |
| `precio_base` | DECIMAL | Precio base antes de modificadores | |
| `stock_disponible` | INT | Cantidad en inventario | |
| `permite_personalizacion` | BOOLEAN | Si acepta rellenos/tama√±os | |

**Caracter√≠sticas especiales:**
- üí∞ **Sistema de precios** (base + ofertas)
- üìä **M√©tricas integradas** (`rating_promedio`, `total_ventas`)
- ‚è±Ô∏è **Gesti√≥n de tiempo** (`tiempo_preparacion_hrs`)
- üéØ **Marketing** (`is_featured`, `is_disponible`)

---

## üîó **TABLAS DE RELACI√ìN (Many-to-Many)**

### üßÅ **3. PRODUCTO_RELLENO** (20 registros, 2 columnas)
**Prop√≥sito:** Conexi√≥n flexible entre productos y rellenos

```sql
CREATE TABLE producto_relleno (
    producto_id INT,
    relleno_id INT,
    PRIMARY KEY (producto_id, relleno_id),
    FOREIGN KEY (producto_id) REFERENCES producto(id),
    FOREIGN KEY (relleno_id) REFERENCES relleno(id)
);
```

### üìè **4. PRODUCTO_TAMA√ëO** (14 registros, 2 columnas)  
**Prop√≥sito:** Conexi√≥n flexible entre productos y tama√±os

```sql
CREATE TABLE producto_tama√±o (
    producto_id INT,
    tama√±o_id INT,
    PRIMARY KEY (producto_id, tama√±o_id),
    FOREIGN KEY (producto_id) REFERENCES producto(id),
    FOREIGN KEY (tama√±o_id) REFERENCES tama√±o(id)
);
```

---

## üé® **TABLAS DE OPCIONES**

### üç∞ **5. RELLENO** (5 registros, 19 columnas)
**Prop√≥sito:** Sabores y rellenos disponibles

| Campo | Tipo | Descripci√≥n | Uso en Precio |
|-------|------|-------------|---------------|
| `id` | INT PK | Identificador √∫nico | |
| `nombre` | VARCHAR | Nombre del relleno | |
| `precio_adicional` | DECIMAL | Costo extra | ‚ûï `producto.precio_base` |
| `is_premium` | BOOLEAN | Relleno premium | üíé Destacado en UI |
| `contiene_lactosa` | BOOLEAN | Info nutricional | ü•õ Alertas |
| `es_vegano` | BOOLEAN | Opci√≥n vegana | üå± Filtros |

### üìê **6. TAMA√ëO** (5 registros, 16 columnas)
**Prop√≥sito:** Tama√±os disponibles para productos

| Campo | Tipo | Descripci√≥n | Uso en Precio |
|-------|------|-------------|---------------|
| `id` | INT PK | Identificador √∫nico | |
| `nombre` | VARCHAR | Nombre del tama√±o | |
| `multiplicador_precio` | DECIMAL | Factor de multiplicaci√≥n | ‚úñÔ∏è `producto.precio_base` |
| `precio_adicional` | DECIMAL | Costo fijo adicional | ‚ûï Despu√©s del multiplicador |
| `porciones_aproximadas` | INT | N√∫mero de porciones | üë• Info para cliente |
| `diametro_cm` | INT | Tama√±o f√≠sico | üìè Especificaciones |

---

## üñºÔ∏è **TABLAS DE CONTENIDO**

### üì∏ **7. PRODUCTO_IMAGEN** (0 registros, 14 columnas)
**Prop√≥sito:** Galer√≠a de im√°genes por producto

| Campo | Tipo | Descripci√≥n | Relaci√≥n |
|-------|------|-------------|----------|
| `id` | INT PK | Identificador √∫nico | |
| `producto_id` | INT FK | Producto asociado | ‚û°Ô∏è `producto.id` |
| `url` | VARCHAR | URL de la imagen | |
| `is_principal` | BOOLEAN | Imagen principal | üåü Hero image |
| `orden` | INT | Orden en galer√≠a | üìë Secuencia |

### üí¨ **8. TESTIMONIO** (5 registros, 20 columnas)
**Prop√≥sito:** Rese√±as y testimonios de clientes

| Campo | Tipo | Descripci√≥n | Relaci√≥n |
|-------|------|-------------|----------|
| `id` | INT PK | Identificador √∫nico | |
| `producto_id` | INT FK | Producto rese√±ado | ‚û°Ô∏è `producto.id` |
| `rating` | DECIMAL | Calificaci√≥n (1-5) | ‚≠ê Estrellas |
| `is_publico` | BOOLEAN | Visible p√∫blicamente | üëÅÔ∏è Moderaci√≥n |
| `is_verificado` | BOOLEAN | Compra verificada | ‚úÖ Confiabilidad |

---

## üîÑ **DIAGRAMA DE RELACIONES**

```mermaid
erDiagram
    CATEGORIA {
        int id PK
        varchar nombre
        varchar slug
        int parent_id FK
        boolean is_featured
        boolean is_active
    }
    
    PRODUCTO {
        int id PK
        int categoria_id FK
        varchar nombre
        decimal precio_base
        boolean permite_personalizacion
        boolean is_featured
        boolean is_disponible
    }
    
    RELLENO {
        int id PK
        varchar nombre
        decimal precio_adicional
        boolean is_premium
        boolean is_disponible
    }
    
    TAMA√ëO {
        int id PK
        varchar nombre
        decimal multiplicador_precio
        decimal precio_adicional
        boolean is_disponible
    }
    
    PRODUCTO_IMAGEN {
        int id PK
        int producto_id FK
        varchar url
        boolean is_principal
        int orden
    }
    
    TESTIMONIO {
        int id PK
        int producto_id FK
        varchar nombre_cliente
        decimal rating
        boolean is_publico
    }
    
    PRODUCTO_RELLENO {
        int producto_id FK
        int relleno_id FK
    }
    
    PRODUCTO_TAMA√ëO {
        int producto_id FK
        int tama√±o_id FK
    }

    %% Relaciones
    CATEGORIA ||--o{ CATEGORIA : "parent_id"
    CATEGORIA ||--o{ PRODUCTO : "categoria_id"
    PRODUCTO ||--o{ PRODUCTO_IMAGEN : "producto_id"
    PRODUCTO ||--o{ TESTIMONIO : "producto_id"
    PRODUCTO ||--o{ PRODUCTO_RELLENO : "producto_id"
    PRODUCTO ||--o{ PRODUCTO_TAMA√ëO : "producto_id"
    RELLENO ||--o{ PRODUCTO_RELLENO : "relleno_id"
    TAMA√ëO ||--o{ PRODUCTO_TAMA√ëO : "tama√±o_id"
```

---

## üí∞ **SISTEMA DE PRECIOS**

### üßÆ **C√°lculo de Precio Final**

```javascript
// F√≥rmula de precio completo
precio_final = (producto.precio_base * tama√±o.multiplicador_precio) 
               + tama√±o.precio_adicional 
               + relleno.precio_adicional

// Ejemplo pr√°ctico:
// Producto: Torta Chocolate (precio_base: $25.000)
// Tama√±o: Grande (multiplicador: 1.5, adicional: $5.000)  
// Relleno: Frambuesa Premium (adicional: $3.000)
// 
// C√°lculo: ($25.000 * 1.5) + $5.000 + $3.000 = $45.500
```

---

## üîç **CONSULTAS CLAVE**

### üìã **1. Obtener producto completo con opciones**
```sql
-- Producto con todas sus opciones disponibles
SELECT 
    p.*,
    c.nombre as categoria_nombre,
    GROUP_CONCAT(DISTINCT r.nombre) as rellenos_disponibles,
    GROUP_CONCAT(DISTINCT t.nombre) as tama√±os_disponibles
FROM producto p
LEFT JOIN categoria c ON p.categoria_id = c.id
LEFT JOIN producto_relleno pr ON p.id = pr.producto_id
LEFT JOIN relleno r ON pr.relleno_id = r.id AND r.is_disponible = 1
LEFT JOIN producto_tama√±o pt ON p.id = pt.producto_id  
LEFT JOIN tama√±o t ON pt.tama√±o_id = t.id AND t.is_disponible = 1
WHERE p.id = ? AND p.is_active = 1
GROUP BY p.id;
```

### üõí **2. Productos por categor√≠a con opciones**
```sql
-- Productos de una categor√≠a con conteo de opciones
SELECT 
    p.*,
    COUNT(DISTINCT pr.relleno_id) as total_rellenos,
    COUNT(DISTINCT pt.tama√±o_id) as total_tama√±os,
    AVG(t.rating) as rating_promedio
FROM producto p
LEFT JOIN producto_relleno pr ON p.id = pr.producto_id
LEFT JOIN producto_tama√±o pt ON p.id = pt.producto_id
LEFT JOIN testimonio t ON p.id = t.producto_id AND t.is_publico = 1
WHERE p.categoria_id = ? AND p.is_disponible = 1
GROUP BY p.id
ORDER BY p.is_featured DESC, p.total_ventas DESC;
```

### üíé **3. Rellenos premium disponibles**
```sql
-- Rellenos premium ordenados por precio
SELECT * FROM relleno 
WHERE is_premium = 1 AND is_disponible = 1 AND is_active = 1
ORDER BY precio_adicional DESC;
```

---

## ‚ö° **OPTIMIZACIONES**

### üìä **√çndices Recomendados**
```sql
-- √çndices para consultas frecuentes
CREATE INDEX idx_producto_categoria ON producto(categoria_id, is_disponible, is_active);
CREATE INDEX idx_producto_featured ON producto(is_featured, total_ventas);
CREATE INDEX idx_relleno_disponible ON relleno(is_disponible, is_premium);
CREATE INDEX idx_tama√±o_disponible ON tama√±o(is_disponible, orden_display);
CREATE INDEX idx_testimonio_publico ON testimonio(producto_id, is_publico, rating);
```

### üîÑ **Triggers Sugeridos**
```sql
-- Actualizar rating promedio autom√°ticamente
DELIMITER $$
CREATE TRIGGER update_producto_rating 
AFTER INSERT ON testimonio
FOR EACH ROW
BEGIN
    UPDATE producto 
    SET rating_promedio = (
        SELECT AVG(rating) 
        FROM testimonio 
        WHERE producto_id = NEW.producto_id AND is_publico = 1
    )
    WHERE id = NEW.producto_id;
END$$
DELIMITER ;
```

---

## üöÄ **ENDPOINTS RELACIONALES**

### üîó **Consultas de Relaci√≥n Directa**
| Endpoint | Descripci√≥n | Relaci√≥n |
|----------|-------------|----------|
| `/productos/{id}/rellenos` | Rellenos de un producto | `producto_relleno` |
| `/productos/{id}/tama√±os` | Tama√±os de un producto | `producto_tama√±o` |
| `/productos/{id}/imagenes` | Im√°genes de un producto | `producto_imagen` |
| `/productos/{id}/testimonios` | Testimonios de un producto | `testimonio` |
| `/categorias/{id}/productos` | Productos de una categor√≠a | `producto.categoria_id` |

### üìà **Consultas Agregadas**
| Endpoint | Descripci√≥n | Funcionalidad |
|----------|-------------|---------------|
| `/productos/destacados/list` | Productos featured | `is_featured = 1` |
| `/rellenos/disponibles/list` | Rellenos activos | `is_disponible = 1` |
| `/testimonios/publicos/list` | Reviews p√∫blicos | `is_publico = 1` |

---

## üìù **REGLAS DE NEGOCIO**

### ‚úÖ **Validaciones Implementadas**
1. **Productos:** Solo se muestran si `is_disponible = 1` AND `is_active = 1`
2. **Rellenos:** Solo disponibles si `is_disponible = 1` AND est√°n relacionados al producto
3. **Tama√±os:** Solo disponibles si `is_disponible = 1` AND est√°n relacionados al producto
4. **Testimonios:** Solo p√∫blicos si `is_publico = 1` AND `is_active = 1`
5. **Categor√≠as:** Jerarqu√≠a con `parent_id` para subcategor√≠as

### üéØ **L√≥gica de Personalizaci√≥n**
- Un producto solo acepta rellenos/tama√±os si `permite_personalizacion = 1`
- Los precios se calculan din√°micamente seg√∫n las selecciones
- Los rellenos premium se destacan visualmente
- Las im√°genes se ordenan por `is_principal` y luego por `orden`

---

## üîê **SEGURIDAD Y INTEGRIDAD**

### üõ°Ô∏è **Constraints Implementadas**
```sql
-- Integridad referencial
FOREIGN KEY (categoria_id) REFERENCES categoria(id) ON DELETE RESTRICT;
FOREIGN KEY (producto_id) REFERENCES producto(id) ON DELETE CASCADE;

-- Validaciones de datos
CHECK (precio_base >= 0);
CHECK (precio_adicional >= 0);
CHECK (rating >= 1 AND rating <= 5);
CHECK (stock_disponible >= 0);
```

### üîÑ **Soft Delete**
Todas las tablas principales usan **eliminaci√≥n suave** con `is_active = 0` para mantener integridad hist√≥rica.

---

## üìä **ESTAD√çSTICAS ACTUALES**

| Tabla | Registros | Estado | Capacidad |
|-------|-----------|--------|-----------|
| **categoria** | 5 | ‚úÖ Poblada | Escalable |
| **producto** | 6 | ‚úÖ Poblada | Escalable |
| **relleno** | 5 | ‚úÖ Poblada | Escalable |
| **tama√±o** | 5 | ‚úÖ Poblada | Escalable |
| **testimonio** | 5 | ‚úÖ Poblada | Escalable |
| **producto_imagen** | 0 | ‚ö†Ô∏è Vac√≠a | Pendiente |
| **producto_relleno** | 20 | ‚úÖ Poblada | Relacional |
| **producto_tama√±o** | 14 | ‚úÖ Poblada | Relacional |

---

## üöÄ **PR√ìXIMOS PASOS**

1. ‚úÖ **Completar im√°genes** - Poblar `producto_imagen`
2. üìä **Agregar m√©tricas** - Triggers para estad√≠sticas autom√°ticas  
3. üîç **Optimizar consultas** - √çndices adicionales seg√∫n uso
4. üé® **Personalizaci√≥n avanzada** - Combinaciones de rellenos
5. üì± **API GraphQL** - Para consultas complejas relacionales

---

*Documentaci√≥n generada para Kokorito Web - Sistema de gesti√≥n de productos de reposter√≠a* 